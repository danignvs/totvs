<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Gerador de Cronograma</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="style.css">

    <style>

        .container {
            grid-template-columns: 1fr 1.5fr;
        }

        .wrapper {
            padding: 7px;
            background-color: var(--cinza-claro);
            border-radius: 3px;
            border: 1px solid var(--cinza);
            position: relative;
            transition: background-color 0.2s;
        }

        .item-lista {
            margin: 10px 0;
        }

        .inp-tarefa {
            width: 100%;
        }

        .marco, .inp-tarefa {
            display: flex;
            align-items: center;
            gap: 7px;
        }
        
        .marco .drag-handle, .marco .excluir {
            color: var(--roxo);
        }

        .tarefa .drag-handle, .tarefa .excluir {
            color: var(--laranja);
        }

        .excluir {
            font-size: 1em;
            font-weight: bold;
            width: auto;
            padding: 0 5px 0 0px;
            float: right;
        }

        .sortable-ghost {
            opacity: 0.4;
            background-color: var(--cinza-claro);
            border: 2px dashed var(--az-claro);
        }

        /* --- CORREﾃﾃグ DA TABELA --- */
        .container-resultado {
            max-width: 100%;
        }

        .tabela-container {
            width: 100%;
            overflow-x: auto; /* Cria barra de rolagem se a tabela for grande */
            background: #fff;
            padding: 10px;
            border: 1px solid var(--cinza);
            border-radius: 3px;
            box-sizing: border-box; /* Garante que padding nﾃ｣o aumente a largura total */
        }

        pre, .tabela-container {
            font-family: Verdana, Geneva, Tahoma, sans-serif;
            font-size: 0.8rem;
        }

        table.custom-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            color: #333;
        }

        table.custom-table th {
            background-color: var(--az-escuro);
            color: white;
            font-weight: bold;
            padding: 10px;
            border: 1px solid var(--az-claro);
            text-align: center;
            vertical-align: middle;
        }

        table.custom-table td {
            padding: 8px;
            border: 1px solid #ccc;
            text-align: center;
            vertical-align: middle;
        }

        table.custom-table td.col-tarefa {
            text-align: left;
            font-weight: 500;
        }

        table.custom-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
            
        /* Inputs de data (Inﾃｭcio e Fim) na mesma linha */
        .tarefa .input-group:nth-child(2) { 
            display: flex;
        }
        
        /* Inputs de Horas e Analista na mesma linha */
        .tarefa .input-group:nth-child(3) { 
            display: flex;
        }

        /* Define larguras especﾃｭficas para ficar proporcional */
        .tarefa .input-group:nth-child(3) .input-item:first-child {
            flex: 1; /* Horas ocupa menos espaﾃｧo (1 parte) */
        }
        
        .tarefa .input-group:nth-child(3) .input-item:last-child {
            flex: 3; /* Analista ocupa mais espaﾃｧo (2 partes) */
        }


    </style>
</head>

<body>

    <div class="container container-azul">

        <datalist id="lista-analistas">
            <option value="Anderson Guilherme">
            <option value="Andre Ferreira">
            <option value="Bruno Silva">
            <option value="Cassio Moraes">
            <option value="Daly Teixeira">
            <option value="Douglas Eduardo">
            <option value="Douglas Rafael">
            <option value="Eduardo Cruz">
            <option value="Felipe Oliveira">
            <option value="Filippe Valle">
            <option value="Gustavo Mizerani">
            <option value="Jairo Da Silva">
            <option value="Karlo Guilherme">
            <option value="Kleverson Nascimento">
            <option value="Leonardo Ventura">
            <option value="Magno Telles">
            <option value="Marcelo Veiga">
            <option value="Marcio Avila">
            <option value="Mario Flavio">
            <option value="Moacyr Campos">
            <option value="Pablo Barbero">
            <option value="Paulo Roberto">
            <option value="Pedro Henrique">
            <option value="Ricardo Mendes">
            <option value="Talles Da Silva">
            <option value="Washington Da Silva">
            <option value="Yure Jonathan">
        </datalist>

        <section class="container-formulario">

            <div class="topo">
                <h2>Planejamento</h2>
            </div>

            <div class="input-group">
                <div class="input-item">
                    <label for="txtCodProjeto">Cﾃｳdigo do Projeto:</label>
                    <input type="text" id="txtCodProjeto" placeholder="Ex: D...001" oninput="gerarTabela()">
                </div>
                <div class="input-item">
                    <label for="txtNomeProjeto">Nome do Projeto:</label>
                    <input type="text" id="txtNomeProjeto" placeholder="Nome do projeto" oninput="gerarTabela()">
                </div>
            </div>

            <label style="margin-bottom: -7px;">Marcos e Tarefas:</label>
            <div id="listaItens">
            </div>

            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="btn-roxo" style="width: auto;" onclick="adicionarMarcoItem()">Adicionar Marco</button>
                <button class="btn-laranja" style="width: auto;" onclick="adicionarNovaTarefa()">Adicionar Tarefa</button>
            </div>

        </section>


        <section class="container-resultado">
            <h3>Resultado</h3>

            <div class="resultado">
                <button class="btn-azul btn-aux" onclick="copiarTexto('resultadoAssunto')">Copiar</button>
                <label>Assunto:</label>
                <pre id="resultadoAssunto"></pre>
            </div>

            <div class="resultado">
                <button class="btn-azul btn-aux" onclick="copiarTabela()">Copiar</button>
                <label>Mensagem:</label>
                <div id="areaTabela" class="tabela-container"></div>
            </div>
        </section>


        <div id="toast">Copiado!</div>
    </div>

    <script>
        // --- FUNﾃﾃグ DE SAUDAﾃﾃグ AUTOMﾃゝICA CORRIGIDA ---
        function obterSaudacao() {
            const hora = parseInt(new Date().toLocaleString("pt-BR", {
                timeZone: "America/Sao_Paulo",
                hour: "numeric",
                hour12: false
            }));

            // Das 00h ﾃs 11:59h -> Bom dia
            if (hora >= 0 && hora < 12) return "Bom dia";
            
            // Das 12h ﾃs 17:59h -> Boa tarde
            if (hora >= 12 && hora < 18) return "Boa tarde";
            
            // Das 18h ﾃs 23:59h -> Boa noite
            return "Boa noite";
        }

        // --- MﾃヾCARA DE DATA ---
        function mascaraData(input) {
            let v = input.value;
            v = v.replace(/\D/g, "");
            if (v.length > 2) v = v.substring(0, 2) + "/" + v.substring(2);
            if (v.length > 5) v = v.substring(0, 5) + "/" + v.substring(5, 9);
            if (v.length > 10) v = v.substring(0, 10);
            input.value = v;
            
            validarDatas(input); // <-- Executa a validaﾃｧﾃ｣o
            gerarTabela();
        }

        // --- VALIDAﾃﾃグ DE DATAS ---
        function validarDatas(input) {
            const wrapper = input.closest('.tarefa-wrapper');
            if (!wrapper) return;

            const inpInicio = wrapper.querySelector('.inp-inicio');
            const inpFim = wrapper.querySelector('.inp-fim');

            // Sﾃｳ faz a checagem se ambas as datas estiverem preenchidas por completo (10 caracteres)
            if (inpInicio.value.length === 10 && inpFim.value.length === 10) {
                const partsInicio = inpInicio.value.split('/');
                const partsFim = inpFim.value.split('/');
                
                // Formato: Ano, Mﾃｪs (0-11), Dia
                const dateInicio = new Date(partsInicio[2], partsInicio[1] - 1, partsInicio[0]);
                const dateFim = new Date(partsFim[2], partsFim[1] - 1, partsFim[0]);

                if (dateFim < dateInicio) {
                    mostrarToast("A data de conclusﾃ｣o nﾃ｣o pode ser anterior ao inﾃｭcio!");
                    inpFim.value = ""; // Limpa o campo de texto
                    
                    // Limpa tambﾃｩm o valor do calendﾃ｡rio (picker) invisﾃｭvel
                    const pickers = wrapper.querySelectorAll('.inp-date-picker');
                    if(pickers[1]) pickers[1].value = ""; 
                }
            }
        }

        function atualizarDataPeloPicker(pickerInput) {
            const valorISO = pickerInput.value;
            if (!valorISO) return;
            const [ano, mes, dia] = valorISO.split('-');
            const wrapper = pickerInput.parentElement;
            const textInput = wrapper.querySelector('.inp-date-text');
            if (textInput) {
                textInput.value = `${dia}/${mes}/${ano}`;
                validarDatas(textInput);
                gerarTabela();
            }
        }

        function validarDatas(input) {
            const wrapper = input.closest('.wrapper');
            if (!wrapper) return;
            // Apenas valida se for tarefa (tem data de inicio)
            const inpInicio = wrapper.querySelector('.inp-inicio');
            if (!inpInicio) return; 

            const inpFim = wrapper.querySelector('.inp-fim');
            if (inpInicio.value.length === 10 && inpFim.value.length === 10) {
                const i = inpInicio.value.split('/');
                const f = inpFim.value.split('/');
                const dInicio = new Date(i[2], i[1]-1, i[0]);
                const dFim = new Date(f[2], f[1]-1, f[0]);
                if (dFim < dInicio) {
                    mostrarToast("A data de conclusﾃ｣o nﾃ｣o pode ser anterior ao inﾃｭcio!");
                    inpFim.value = "";
                    wrapper.querySelectorAll('.inp-date-picker')[1].value = "";
                }
            }
        }

        function formatarDataFinal(valor) {
            if (!valor) return "";
            if (valor.length === 10 && valor.includes('/')) return valor.substring(0, 6) + valor.substring(8, 10);
            return valor;
        }

        // --- GERENCIAMENTO DE ITENS ---
        let historicoExclusoes = [];

        function adicionarNovaTarefa() {
            const container = document.getElementById('listaItens');
            const idUnico = Date.now();
            const div = document.createElement('div');
            // Adiciona classes 'wrapper' (caixa cinza) e 'tarefa' (layout coluna)
            div.className = 'wrapper item-lista tarefa';
            div.dataset.type = 'tarefa';
            div.id = 'item-' + idUnico;

            div.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; gap: 7px; ">
                    <div style="display:flex; align-items:center; flex:1; gap: 7px;">
                        <span class="drag-handle" title="Mover">笘ｰ</span>
                        <input type="text" class="inp-tarefa" placeholder="Descriﾃｧﾃ｣o da tarefa..." oninput="gerarTabela()" style="margin:0; width:100%; margin: 5px 0;">
                    </div>
                    <button class="excluir" style="margin:0;" onclick="removerItem('${idUnico}')">X</button>
                </div>
                

                <div class="input-group">
                    <div class="input-item">
                        <div class="custom-date-wrapper">
                            <input type="text" class="inp-date-text inp-inicio" placeholder="Data Inﾃｭcio" maxlength="10" oninput="mascaraData(this)">
                            <span class="calendar-icon">套</span>
                            <input type="date" class="inp-date-picker" onchange="atualizarDataPeloPicker(this)">
                        </div>
                    </div>
                    <div class="input-item">
                        <div class="custom-date-wrapper">
                            <input type="text" class="inp-date-text inp-fim" placeholder="Data Conclusﾃ｣o" maxlength="10" oninput="mascaraData(this)">
                            <span class="calendar-icon">套</span>
                            <input type="date" class="inp-date-picker" onchange="atualizarDataPeloPicker(this)">
                        </div>
                    </div>
                </div>

                <div class="input-group" style="margin-bottom:0;">
                    <div class="input-item">
                        <input type="text" class="inp-horas" placeholder="Horas (0,00)" oninput="gerarTabela()">
                    </div>
                    <div class="input-item">
                        <input type="text" class="inp-analista" list="lista-analistas" placeholder="Nome do Analista" oninput="gerarTabela()">
                    </div>
                </div>
            `;
            container.appendChild(div);
            gerarTabela();
        }

        function adicionarMarcoItem() {
            const container = document.getElementById('listaItens');
            const idUnico = Date.now();
            const div = document.createElement('div');
            // Adiciona classes 'wrapper' (caixa cinza) e 'marco' (layout linha)
            div.className = 'wrapper item-lista marco';
            div.dataset.type = 'marco';
            div.id = 'item-' + idUnico;

            div.innerHTML = `
                <span class="drag-handle" title="Mover">笘ｰ</span>
                <input type="text" class="inp-marco" placeholder="Marco" oninput="gerarTabela()" style="flex:1;">
                <button class="excluir" style="margin:0;" onclick="removerItem('${idUnico}')">X</button>
            `;
            container.appendChild(div);
            gerarTabela();
        }

        function removerItem(id) {
            const el = document.getElementById('item-' + id);
            if (el) {
                const tipo = el.dataset.type;
                let valores = {};
                
                if (tipo === 'tarefa') {
                    valores = {
                        tarefa: el.querySelector('.inp-tarefa').value,
                        inicio: el.querySelector('.inp-inicio').value,
                        fim: el.querySelector('.inp-fim').value,
                        horas: el.querySelector('.inp-horas').value,
                        analista: el.querySelector('.inp-analista').value
                    };
                } else {
                    // Aqui pegamos o valor do input com classe .inp-marco
                    valores = { marco: el.querySelector('.inp-marco').value };
                }

                historicoExclusoes.push({
                    id: id,
                    tipo: tipo,
                    html: el.innerHTML,
                    valores: valores
                });

                el.remove();
                gerarTabela();
                mostrarToast("Item removido. Ctrl+Z para desfazer.");
            }
        }

        function desfazerExclusao() {
            if (historicoExclusoes.length === 0) return;
            const item = historicoExclusoes.pop();
            const container = document.getElementById('listaItens');
            
            const div = document.createElement('div');
            div.id = 'item-' + item.id;
            
            // CORREﾃﾃグ: Restaura a classe correta (marco ou tarefa)
            if(item.tipo === 'tarefa') {
                div.className = 'wrapper item-lista tarefa';
            } else {
                div.className = 'wrapper item-lista marco';
            }
            
            div.dataset.type = item.tipo;
            div.innerHTML = item.html;
            container.appendChild(div);

            // Restaura valores
            if (item.tipo === 'tarefa') {
                div.querySelector('.inp-tarefa').value = item.valores.tarefa;
                div.querySelector('.inp-inicio').value = item.valores.inicio;
                div.querySelector('.inp-fim').value = item.valores.fim;
                div.querySelector('.inp-horas').value = item.valores.horas;
                div.querySelector('.inp-analista').value = item.valores.analista;
            } else {
                // CORREﾃﾃグ: Restaura o valor no input correto
                div.querySelector('.inp-marco').value = item.valores.marco;
            }

            gerarTabela();
            mostrarToast("Desfeito!");
        }

        // --- GERAﾃﾃグ DA TABELA ---
        function gerarTabela() {
            const codProjeto = document.getElementById('txtCodProjeto').value;
            const nomeProjeto = document.getElementById('txtNomeProjeto').value;

            // Assunto
            let assunto = "Liberaﾃｧﾃ｣o para Planejamento";
            if (codProjeto) assunto += ` - ${codProjeto}`;
            if (nomeProjeto) assunto += ` - ${nomeProjeto}`;
            document.getElementById('resultadoAssunto').textContent = assunto;

            // Percorre a lista
            const itens = document.querySelectorAll('.item-lista');
            let linhasHTML = '';
            let totalHoras = 0;

            itens.forEach(el => {
                if (el.dataset.type === 'marco') {
                    // Renderiza linha de MARCO
                    const titulo = el.querySelector('.inp-marco').value.toUpperCase();
                    linhasHTML += `
                        <tr>
                            <td colspan="5" style="background-color: #f0f0f0; font-weight: bold; text-align: left; padding: 10px; border: 1px solid #ccc; color: #002233;">
                                ${titulo}
                            </td>
                        </tr>
                    `;
                } else {
                    // Renderiza linha de TAREFA
                    let desc = el.querySelector('.inp-tarefa').value;
                    // Capitaliza a primeira letra (Ex: "teste" -> "Teste")
                    if (desc.length > 0) {
                        desc = desc.charAt(0).toUpperCase() + desc.slice(1);
                    }
                    const inicio = el.querySelector('.inp-inicio').value;
                    const fim = el.querySelector('.inp-fim').value;
                    let horasStr = el.querySelector('.inp-horas').value.replace(',', '.');
                    const analista = el.querySelector('.inp-analista').value;

                    const h = parseFloat(horasStr);
                    if (!isNaN(h)) totalHoras += h;

                    const iniFmt = formatarDataFinal(inicio);
                    const fimFmt = formatarDataFinal(fim);
                    const horasExib = horasStr.replace('.', ',');

                    if (desc || inicio || fim || horasStr || analista) {
                        linhasHTML += `
                            <tr>
                                <td style="text-align: left; padding: 8px; border: 1px solid #ccc;">${desc}</td>
                                <td style="text-align: center; padding: 8px; border: 1px solid #ccc;">${iniFmt}</td>
                                <td style="text-align: center; padding: 8px; border: 1px solid #ccc;">${fimFmt}</td>
                                <td style="text-align: center; padding: 8px; border: 1px solid #ccc;">${horasExib}</td>
                                <td style="text-align: center; padding: 8px; border: 1px solid #ccc;">${analista}</td>
                            </tr>
                        `;
                    }
                }
            });

            const totalFmt = totalHoras.toFixed(2).replace('.', ',');
            const saudacao = obterSaudacao();

            const htmlTabela = `
                <div id="resultadoCorpo" style="font-family: Verdana, Geneva, Tahoma, sans-serif; font-size: 13px; color: #333;">
                    <p>${saudacao},</p>
                    <p>Segue planejamento para o projeto:</p>
                    <strong>${codProjeto}  ${nomeProjeto}</strong>
                    <br><br>

                    <table style="width: 100%; max-width: 600px; border-collapse: collapse; font-family: 'Segoe UI', sans-serif;">
                        <thead>
                            <tr style="background-color: #002233; color: white;">
                                <th style="padding: 10px; border: 1px solid #000;"></th> 
                                <th style="padding: 10px; border: 1px solid #000; width: 80px;">INﾃ垢IO</th>
                                <th style="padding: 10px; border: 1px solid #000; width: 80px;">CONCLUSﾃグ</th>
                                <th style="padding: 10px; border: 1px solid #000; width: 60px;">HORAS</th>
                                <th style="padding: 10px; border: 1px solid #000; width: 100px;">ANALISTA</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${linhasHTML}
                            <tr>
                                <td colspan="3" style="text-align: right; font-weight: bold; padding: 10px; border: 1px solid #ccc;">TOTAL</td>
                                <td style="text-align: center; font-weight: bold; padding: 10px; border: 1px solid #ccc;">${totalFmt}</td>
                                <td style="border: 1px solid #ccc;"></td>
                            </tr>
                        </tbody>
                    </table>
                    <br>
                    <p>Fico ﾃ disposiﾃｧﾃ｣o para qualquer dﾃｺvida.</p>
                    <p>Atenciosamente,</p>
                </div>
            `;
            document.getElementById('areaTabela').innerHTML = htmlTabela;
        }

        // Utils
        function mostrarToast(txt) {
            const x = document.getElementById("toast");
            x.textContent = txt; x.className = "show";
            setTimeout(() => { x.className = x.className.replace("show", ""); }, 3000);
        }
        function copiarTexto(id) {
            const txt = document.getElementById(id).textContent;
            if(txt) navigator.clipboard.writeText(txt).then(() => mostrarToast("Copiado!"));
        }
        function copiarTabela() {
            const el = document.getElementById('resultadoCorpo');
            if(!el) return;
            const r = document.createRange(); r.selectNode(el);
            window.getSelection().removeAllRanges(); window.getSelection().addRange(r);
            document.execCommand('copy');
            window.getSelection().removeAllRanges();
            mostrarToast("Tabela copiada!");
        }
        function limparTudo() {
            document.getElementById('txtCodProjeto').value='';
            document.getElementById('txtNomeProjeto').value='';
            document.getElementById('listaItens').innerHTML='';
            adicionarMarcoItem();
            adicionarNovaTarefa(); 
            gerarTabela();
        }

        document.addEventListener('keydown', e => {
            if((e.ctrlKey || e.metaKey) && e.key === 'z') {
                const tag = document.activeElement.tagName.toLowerCase();
                if(tag !== 'input' && tag !== 'textarea') { e.preventDefault(); desfazerExclusao(); }
            }
        });

        window.onload = function() {
            adicionarMarcoItem(); 
            adicionarNovaTarefa();
            const el = document.getElementById('listaItens');
            Sortable.create(el, { handle: '.drag-handle', animation: 150, onEnd: gerarTabela });
        };
    </script>
</body>
</html>