<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Planejamento</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="style.css">

    <style>

        .container {
            grid-template-columns: 1fr 1.5fr;
        }

        .wrapper {
            padding: 7px;
            background-color: var(--cinza-claro);
            border-radius: 3px;
            border: 1px solid var(--cinza);
            position: relative;
            transition: background-color 0.2s;
        }

        .item-lista {
            margin: 10px 0;
        }

        .inp-tarefa {
            width: 100%;
        }

        .marco, .inp-tarefa {
            display: flex;
            align-items: center;
            gap: 7px;
        }
        
        .marco .drag-handle, .marco .excluir {
            color: var(--roxo);
            font-weight: bold;
        }

        .tarefa .drag-handle, .tarefa .excluir {
            color: var(--laranja);
            font-weight: bold;
        }

        .excluir {
            font-size: 1em;
            font-weight: bold;
            width: auto;
            padding: 0 5px 0 0px;
            float: right;
        }

        .sortable-ghost {
            opacity: 0.4;
            background-color: var(--cinza-claro);
            border: 2px dashed var(--az-claro);
        }

        /* --- CORRE√á√ÉO DA TABELA --- */
        .container-resultado {
            max-width: 100%;
        }

        .tabela-container {
            width: 100%;
            overflow-x: auto; /* Cria barra de rolagem se a tabela for grande */
            background: #fff;
            padding: 10px;
            border: 1px solid var(--cinza);
            border-radius: 3px;
            box-sizing: border-box; /* Garante que padding n√£o aumente a largura total */
        }

        pre, .tabela-container {
            font-family: Verdana, Geneva, Tahoma, sans-serif;
            font-size: 0.8rem;
        }

        table.custom-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            color: #333;
        }

        table.custom-table th {
            background-color: var(--az-escuro);
            color: white;
            font-weight: bold;
            padding: 10px;
            border: 1px solid var(--az-claro);
            text-align: center;
            vertical-align: middle;
        }

        table.custom-table td {
            padding: 8px;
            border: 1px solid #ccc;
            text-align: center;
            vertical-align: middle;
        }

        table.custom-table td.col-tarefa {
            text-align: left;
            font-weight: 500;
        }

        table.custom-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
            
        /* Inputs de data (In√≠cio e Fim) na mesma linha */
        .tarefa .input-group:nth-child(2) { 
            display: flex;
        }
        
        /* Inputs de Horas e Analista na mesma linha */
        .tarefa .input-group:nth-child(3) { 
            display: flex;
        }

        /* Define larguras espec√≠ficas para ficar proporcional */
        .tarefa .input-group:nth-child(3) .input-item:first-child {
            flex: 1; /* Horas ocupa menos espa√ßo (1 parte) */
        }
        
        .tarefa .input-group:nth-child(3) .input-item:last-child {
            flex: 3; /* Analista ocupa mais espa√ßo (2 partes) */
        }


    </style>
</head>

<body>

    <h1>Planejamento de Projetos</h1>

    <div class="container container-azul">

        <datalist id="lista-analistas">
            <option value="Anderson Guilherme">
            <option value="Andre Ferreira">
            <option value="Bruno Silva">
            <option value="Cassio Moraes">
            <option value="Daly Teixeira">
            <option value="Douglas Eduardo">
            <option value="Douglas Rafael">
            <option value="Eduardo Cruz">
            <option value="Felipe Oliveira">
            <option value="Filippe Valle">
            <option value="Gustavo Cipriano">
            <option value="Gustavo Mizerani">
            <option value="Jairo Da Silva">
            <option value="Karlo Guilherme">
            <option value="Kleverson Nascimento">
            <option value="Leonardo Ventura">
            <option value="Magno Telles">
            <option value="Marcelo Veiga">
            <option value="Marcio Avila">
            <option value="Mario Flavio">
            <option value="Moacyr Campos">
            <option value="Pablo Barbero">
            <option value="Paulo Roberto">
            <option value="Pedro Henrique">
            <option value="Ricardo Mendes">
            <option value="Talles Da Silva">
            <option value="Washington Da Silva">
            <option value="Yure Jonathan">
        </datalist>


        <section class="container-formulario">

            <div class="topo">
                <h2></h2>
            </div>

            <div class="input-group">
                <div class="input-item">
                    <label for="txtCodProjeto">C√≥digo do Projeto:</label>
                    <input type="text" id="txtCodProjeto" placeholder="" oninput="gerarTabela()">
                </div>
                <div class="input-item">
                    <label for="txtNomeProjeto">Nome do Projeto:</label>
                    <input type="text" id="txtNomeProjeto" placeholder="" oninput="gerarTabela()">
                </div>
            </div>

            <label style="margin-bottom: -7px;">Marcos e Tarefas:</label>
            <div id="listaItens">
            </div>

            <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="processarArquivo(this)">

            <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                <button class="btn-roxo" style="flex: 1;" onclick="adicionarMarcoItem()">Adicionar Marco</button>
                <button class="btn-laranja" style="flex: 1;" onclick="adicionarNovaTarefa()">Adicionar Tarefa</button>
            </div>

            <br>
            <div class="input-item">
                <label for="txtObservacao">Observa√ß√£o:</label>
                <input type="text" id="txtObservacao" placeholder="" oninput="gerarTabela()">
            </div>

        </section>


        <section class="container-resultado">
            <div class="topo">
                <h3></h3>
            </div>

            <div class="resultado">
                <button class="btn-azul btn-aux" onclick="copiarTexto('resultadoAssunto')">Copiar</button>
                <label>Assunto:</label>
                <pre id="resultadoAssunto"></pre>
            </div>

            <div class="resultado">
                <button class="btn-azul btn-aux" onclick="copiarTabela()">Copiar</button>
                <label>Mensagem:</label>
                <div id="areaTabela" class="tabela-container"></div>
            </div>
        </section>


        <div id="toast">Copiado!</div>
    </div>
                
    
    <div class="menu">
        
        <button><a href="planejamento.html" target="_blank" style="text-decoration: none;">Novo</a></button>

        <button onclick="document.getElementById('fileInput').click()">Abrir</button>
        
        <button onclick="baixarBackup()">Salvar</button> 
        
        <button onclick="limparTudo()">Limpar</button>

    </div>

    <script>
        // --- UTILIT√ÅRIOS GERAIS ---
    
    // Fun√ß√£o Debounce: Evita que o salvamento/URL ocorra a cada tecla, aguardando o usu√°rio parar de digitar
    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), wait);
        };
    }

    // --- GERENCIAMENTO DE INST√ÇNCIA E URL ---
    
    function obterIdInstancia() {
        const params = new URLSearchParams(window.location.search);
        let id = params.get('id');
        // Se n√£o houver ID, n√£o cria um imediatamente para n√£o sujar a URL sem necessidade
        // Usaremos um tempor√°rio interno at√© o primeiro salvamento
        if (!id) {
            id = 'temp_' + Date.now().toString(36);
        }
        return id;
    }

    // Atualiza a URL sem recarregar a p√°gina
    const atualizarUrlDebounced = debounce((novoCodOuId) => {
        if (!novoCodOuId) return;

        // Limpa o ID: remove espa√ßos e caracteres especiais
        const idLimpo = novoCodOuId.trim().replace(/[^a-zA-Z0-9-_]/g, '');
        const idFinal = idLimpo || currentInstanceId; // Mant√©m o atual se o input estiver vazio

        // S√≥ atualiza se mudou
        const params = new URLSearchParams(window.location.search);
        if (params.get('id') !== idFinal && !idFinal.startsWith('temp_')) {
            const novaUrl = window.location.pathname + '?id=' + encodeURIComponent(idFinal);
            window.history.replaceState({path: novaUrl}, '', novaUrl);
            currentInstanceId = idFinal;
        }
    }, 1000); // Espera 1 segundo ap√≥s parar de digitar para mudar a URL

    let currentInstanceId = obterIdInstancia();

    // --- INICIALIZA√á√ÉO ---
    if (history.scrollRestoration) history.scrollRestoration = 'manual';
    window.scrollTo(0, 0);

    function obterSaudacao() {
        const hora = parseInt(new Date().toLocaleString("pt-BR", { timeZone: "America/Sao_Paulo", hour: "numeric", hour12: false }));
        if (hora >= 5 && hora < 12) return "Bom dia";
        if (hora >= 12 && hora < 18) return "Boa tarde";
        return "Boa noite";
    }

    // --- M√ÅSCARAS E TRATAMENTO DE DADOS ---

    function mascaraData(input) {
        let v = input.value.replace(/\D/g, "");
        
        // Impede que o usu√°rio digite mais do que o necess√°rio
        if (v.length > 8) v = v.substring(0, 8);

        if (v.length > 2) v = v.substring(0, 2) + "/" + v.substring(2);
        if (v.length > 5) v = v.substring(0, 5) + "/" + v.substring(5);
        
        input.value = v;
        
        // S√≥ valida se tiver a data completa
        if(v.length === 10) validarDatas(input);
        
        gerarTabela();
    }

    // Parse de string "DD/MM/AAAA" para objeto Date seguro
    function stringParaData(dataStr) {
        if (!dataStr || dataStr.length !== 10) return null;
        const partes = dataStr.split('/');
        const dia = parseInt(partes[0], 10);
        const mes = parseInt(partes[1], 10) - 1; // Mes √© 0-indexado
        const ano = parseInt(partes[2], 10);
        
        const data = new Date(ano, mes, dia);
        
        // Verifica se √© uma data v√°lida (ex: n√£o aceita 31/02)
        if (data.getFullYear() === ano && data.getMonth() === mes && data.getDate() === dia) {
            return data;
        }
        return null;
    }

    function validarDatas(input) {
        const wrapper = input.closest('.wrapper');
        if (!wrapper) return;
        
        const inpInicio = wrapper.querySelector('.inp-inicio');
        const inpFim = wrapper.querySelector('.inp-fim');
        
        if (!inpInicio || !inpFim) return;

        const dInicio = stringParaData(inpInicio.value);
        const dFim = stringParaData(inpFim.value);

        if (dInicio && dFim) {
            if (dFim < dInicio) {
                mostrarToast("Aten√ß√£o: Data final √© menor que a inicial!");
                // N√£o apagamos automaticamente para n√£o frustrar o usu√°rio, 
                // mas voc√™ pode descomentar a linha abaixo se preferir:
                // inpFim.value = ""; 
                inpFim.style.borderColor = "var(--vermelho)";
            } else {
                inpFim.style.borderColor = "var(--cinza)";
            }
        }
    }

    function atualizarDataPeloPicker(pickerInput) {
        const valorISO = pickerInput.value; // Formato yyyy-mm-dd
        if (!valorISO) return;
        
        const [ano, mes, dia] = valorISO.split('-');
        const wrapper = pickerInput.parentElement;
        const textInput = wrapper.querySelector('.inp-date-text');
        
        if (textInput) {
            textInput.value = `${dia}/${mes}/${ano}`;
            validarDatas(textInput);
            gerarTabela();
        }
    }

    function formatarDataFinal(valor) {
        if (!valor) return "";
        // Remove o ano se estiver no formato DD/MM/AAAA para economizar espa√ßo na tabela, se desejar.
        // O c√≥digo original fazia substring(0, 6) + substring(8, 10).
        // Vamos manter o padr√£o DD/MM para visualiza√ß√£o limpa.
        if (valor.length === 10 && valor.includes('/')) {
            return valor.substring(0, 5); // Retorna DD/MM
        }
        return valor;
    }

    function parseHoras(valor) {
        if (!valor) return 0;
        // Substitui v√≠rgula por ponto e remove tudo que n√£o for n√∫mero ou ponto
        let limpo = valor.replace(',', '.').replace(/[^0-9.]/g, '');
        // Garante apenas um ponto decimal
        const partes = limpo.split('.');
        if (partes.length > 2) {
            limpo = partes[0] + '.' + partes.slice(1).join('');
        }
        const floatVal = parseFloat(limpo);
        return isNaN(floatVal) ? 0 : floatVal;
    }

    // --- MANIPULA√á√ÉO DO DOM ---
    
    let historicoExclusoes = [];

    function adicionarNovaTarefa() {
        criarElemento('tarefa');
    }

    function adicionarMarcoItem() {
        criarElemento('marco');
    }

    function criarElemento(tipo, dados = null) {
        const container = document.getElementById('listaItens');
        const idUnico = Date.now().toString(36) + Math.random().toString(36).substring(2);
        const div = document.createElement('div');
        
        div.id = 'item-' + idUnico;
        div.dataset.type = tipo;
        
        // HTML interno (Mantido id√™ntico ao original para n√£o quebrar estilos)
        if (tipo === 'tarefa') {
            div.className = 'wrapper item-lista tarefa';
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; gap: 7px; ">
                    <div style="display:flex; align-items:center; flex:1; gap: 7px;">
                        <span class="drag-handle" title="Mover">‚ò∞</span>
                        <input type="text" class="inp-tarefa" placeholder="Tarefa" oninput="gerarTabela()" style="margin:0; width:100%; margin: 5px 0;">
                    </div>
                    <button class="excluir" style="margin:0;" onclick="removerItem('${idUnico}')">X</button>
                </div>
                <div class="input-group">
                    <div class="input-item">
                        <div class="custom-date-wrapper">
                            <input type="text" class="inp-date-text inp-inicio" placeholder="Data In√≠cio" maxlength="10" oninput="mascaraData(this)">
                            <span class="calendar-icon">üìÖ</span>
                            <input type="date" class="inp-date-picker" onchange="atualizarDataPeloPicker(this)">
                        </div>
                    </div>
                    <div class="input-item">
                        <div class="custom-date-wrapper">
                            <input type="text" class="inp-date-text inp-fim" placeholder="Data Conclus√£o" maxlength="10" oninput="mascaraData(this)">
                            <span class="calendar-icon">üìÖ</span>
                            <input type="date" class="inp-date-picker" onchange="atualizarDataPeloPicker(this)">
                        </div>
                    </div>
                </div>
                <div class="input-group" style="margin-bottom:0;">
                    <div class="input-item">
                        <input type="text" class="inp-horas" placeholder="Horas (0,00)" oninput="gerarTabela()">
                    </div>
                    <div class="input-item">
                        <input type="text" class="inp-analista" list="lista-analistas" placeholder="Nome do Analista" oninput="gerarTabela()">
                    </div>
                </div>
            `;
        } else {
            div.className = 'wrapper item-lista marco';
            div.innerHTML = `
                <span class="drag-handle" title="Mover">‚ò∞</span>
                <input type="text" class="inp-marco" placeholder="MARCO" oninput="gerarTabela()" style="flex:1;">
                <button class="excluir" style="margin:0;" onclick="removerItem('${idUnico}')">X</button>
            `;
        }

        container.appendChild(div);

        // Preenchimento de dados (se houver)
        if (dados) {
            if (tipo === 'tarefa') {
                div.querySelector('.inp-tarefa').value = dados.tarefa || '';
                div.querySelector('.inp-inicio').value = dados.inicio || '';
                div.querySelector('.inp-fim').value = dados.fim || '';
                div.querySelector('.inp-horas').value = dados.horas || '';
                div.querySelector('.inp-analista').value = dados.analista || '';
            } else {
                div.querySelector('.inp-marco').value = dados.valor || '';
            }
        }

        gerarTabela();
    }

    function removerItem(id) {
        const el = document.getElementById('item-' + id);
        if (el) {
            const tipo = el.dataset.type;
            let valores = {};
            
            // Salva o estado antes de excluir para o Undo
            if (tipo === 'tarefa') {
                valores = {
                    tarefa: el.querySelector('.inp-tarefa').value,
                    inicio: el.querySelector('.inp-inicio').value,
                    fim: el.querySelector('.inp-fim').value,
                    horas: el.querySelector('.inp-horas').value,
                    analista: el.querySelector('.inp-analista').value
                };
            } else {
                valores = { valor: el.querySelector('.inp-marco').value };
            }
            
            historicoExclusoes.push({ id, tipo, valores }); 
            el.remove();
            gerarTabela();
            mostrarToast("Item removido. Ctrl+Z para desfazer.");
        }
    }

    function desfazerExclusao() {
        if (historicoExclusoes.length === 0) return;
        const item = historicoExclusoes.pop();
        criarElemento(item.tipo, item.valores);
        mostrarToast("A√ß√£o desfeita!");
    }

    // --- SALVAMENTO E CARREGAMENTO ---

    function coletarDadosParaSalvar() {
        const dados = {
            codProjeto: document.getElementById('txtCodProjeto').value,
            nomeProjeto: document.getElementById('txtNomeProjeto').value,
            observacao: document.getElementById('txtObservacao').value,
            itens: []
        };

        document.querySelectorAll('.item-lista').forEach(el => {
            if (el.dataset.type === 'marco') {
                dados.itens.push({
                    type: 'marco',
                    valor: el.querySelector('.inp-marco').value
                });
            } else {
                dados.itens.push({
                    type: 'tarefa',
                    tarefa: el.querySelector('.inp-tarefa').value,
                    inicio: el.querySelector('.inp-inicio').value,
                    fim: el.querySelector('.inp-fim').value,
                    horas: el.querySelector('.inp-horas').value,
                    analista: el.querySelector('.inp-analista').value
                });
            }
        });
        return dados;
    }

    // Fun√ß√£o debounced para salvar (evita escritas excessivas no disco/storage)
    const salvarDadosStorage = debounce((dados) => {
        // Atualiza a URL baseada no c√≥digo do projeto (se houver)
        if (dados.codProjeto && dados.codProjeto.trim() !== "") {
            atualizarUrlDebounced(dados.codProjeto);
        }
        
        // Salva usando o ID da inst√¢ncia (seja o da URL ou o tempor√°rio)
        localStorage.setItem('planejamento_' + currentInstanceId, JSON.stringify(dados));
        
        // Log discreto para debug
        // console.log("Dados salvos automaticamente em: planejamento_" + currentInstanceId);
    }, 1000);

    function triggerSalvar() {
        const dados = coletarDadosParaSalvar();
        salvarDadosStorage(dados);
    }

    async function baixarBackup() {
        const dados = coletarDadosParaSalvar();
        const cod = dados.codProjeto ? dados.codProjeto.trim() : 'Novo';
        const nomeSugestao = `Planejamento_${cod}.json`;
        const conteudo = JSON.stringify(dados, null, 2);

        if (window.showSaveFilePicker) {
            try {
                const handle = await window.showSaveFilePicker({
                    suggestedName: nomeSugestao,
                    types: [{
                        description: 'Arquivo JSON',
                        accept: {'application/json': ['.json']},
                    }],
                });
                const writable = await handle.createWritable();
                await writable.write(conteudo);
                await writable.close();
                mostrarToast("Arquivo salvo com sucesso!");
            } catch (err) {
                // Usu√°rio cancelou ou erro
            }
        } else {
            // Fallback
            const blob = new Blob([conteudo], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = nomeSugestao;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            mostrarToast("Download iniciado!");
        }
    }

    function processarArquivo(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const dados = JSON.parse(e.target.result);
                if(!dados || (!dados.itens && !dados.codProjeto)) {
                    throw new Error("Formato inv√°lido");
                }
                restaurarTela(dados);
                mostrarToast("Planejamento carregado!");
            } catch (err) {
                alert("Erro ao ler o arquivo JSON. Verifique se √© um backup v√°lido.");
                console.error(err);
            }
            // Importante: limpa o input para permitir recarregar o mesmo arquivo se necess√°rio
            input.value = ''; 
        };
        reader.readAsText(file);
    }

    function carregarDadosIniciais() {
        const dadosSalvos = localStorage.getItem('planejamento_' + currentInstanceId);
        
        // Se a URL tiver um ID mas o storage estiver vazio (link compartilhado sem backend),
        // aqui seria o lugar de buscar num banco de dados real.
        // Como √© 100% local, apenas carregamos se existir no navegador do usu√°rio.
        
        if (dadosSalvos) {
            try {
                restaurarTela(JSON.parse(dadosSalvos));
            } catch(e) {
                console.error("Erro ao carregar storage", e);
                iniciarTelaPadrao();
            }
        } else {
            iniciarTelaPadrao();
        }
    }
    
    function iniciarTelaPadrao() {
        adicionarMarcoItem();
        adicionarNovaTarefa();
        gerarTabela();
    }

    function restaurarTela(dados) {
        document.getElementById('txtCodProjeto').value = dados.codProjeto || '';
        document.getElementById('txtNomeProjeto').value = dados.nomeProjeto || '';
        document.getElementById('txtObservacao').value = dados.observacao || '';
        
        // Se carregou um arquivo com c√≥digo de projeto, atualizamos a URL
        if(dados.codProjeto) {
             // For√ßa atualiza√ß√£o imediata da vari√°vel de ID para sincronizar o salvamento futuro
             // Mas n√£o muda a URL visualmente at√© o debounce, ou podemos for√ßar aqui:
             // currentInstanceId = dados.codProjeto.trim().replace(/[^a-zA-Z0-9-_]/g, '');
        }

        const container = document.getElementById('listaItens');
        container.innerHTML = '';

        if (dados.itens && dados.itens.length > 0) {
            dados.itens.forEach(item => criarElemento(item.type, item));
        } else {
            iniciarTelaPadrao();
        }
        
        gerarTabela();
    }

    // --- GERA√á√ÉO DA TABELA (CORE) ---

    function gerarTabela() {
        const codProjeto = document.getElementById('txtCodProjeto').value;
        const nomeProjeto = document.getElementById('txtNomeProjeto').value;
        const observacao = document.getElementById('txtObservacao').value.trim();

        let tituloAba = "Planejamento de Projetos";
        if (codProjeto && nomeProjeto) {
            tituloAba = `${codProjeto} - ${nomeProjeto}`;
        } else if (codProjeto || nomeProjeto) {
            tituloAba = codProjeto || nomeProjeto;
        }
        document.title = tituloAba;

        let assunto = "Libera√ß√£o para Planejamento";
        if (codProjeto) assunto += ` - ${codProjeto}`;
        if (nomeProjeto) assunto += ` - ${nomeProjeto}`;
        document.getElementById('resultadoAssunto').textContent = assunto;

        // 2. Processa Itens
        const itens = document.querySelectorAll('.item-lista');
        let linhasHTML = '';
        let totalHoras = 0;

        itens.forEach(el => {
            if (el.dataset.type === 'marco') {
                const titulo = el.querySelector('.inp-marco').value.toUpperCase();
                // S√≥ exibe marco se tiver texto
                if(titulo.trim()) {
                    linhasHTML += `
                        <tr>
                            <td colspan="5" style="background-color: #f0f0f0; font-weight: bold; text-align: left; padding: 10px; border: 1px solid #ccc; color: #002233;">${titulo}</td>
                        </tr>
                    `;
                }
            } else {
                let desc = el.querySelector('.inp-tarefa').value;
                const inicio = el.querySelector('.inp-inicio').value;
                const fim = el.querySelector('.inp-fim').value;
                const horasInput = el.querySelector('.inp-horas').value;
                const analista = el.querySelector('.inp-analista').value;

                // Capitaliza primeira letra
                if (desc.length > 0) desc = desc.charAt(0).toUpperCase() + desc.slice(1);
                
                // Calcula horas de forma segura
                const h = parseHoras(horasInput);
                totalHoras += h;

                // Formata√ß√µes para exibi√ß√£o
                const iniFmt = formatarDataFinal(inicio); // Agora retorna s√≥ DD/MM se tiver ano
                const fimFmt = formatarDataFinal(fim);
                
                // Formata n√∫mero para BR (2 casas decimais, v√≠rgula)
                const horasExib = h > 0 ? h.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : "";

                // S√≥ adiciona na tabela se tiver algum dado relevante
                if (desc || inicio || fim || h > 0 || analista) {
                    linhasHTML += `
                        <tr>
                            <td style="text-align: left; padding: 8px; border: 1px solid #ccc;">${desc}</td>
                            <td style="text-align: center; padding: 8px; border: 1px solid #ccc;">${iniFmt}</td>
                            <td style="text-align: center; padding: 8px; border: 1px solid #ccc;">${fimFmt}</td>
                            <td style="text-align: center; padding: 8px; border: 1px solid #ccc;">${horasExib}</td>
                            <td style="text-align: center; padding: 8px; border: 1px solid #ccc;">${analista}</td>
                        </tr>
                    `;
                }
            }
        });

        const totalFmt = totalHoras.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        const saudacao = obterSaudacao();

        const blocoObservacao = observacao ? `<br><p><strong>Observa√ß√£o:</strong> ${observacao}</p>` : '';

        // 3. Monta HTML Final
        const htmlTabela = `
            <div id="resultadoCorpo" style="font-family: Verdana, Geneva, Tahoma, sans-serif; font-size: 13px; color: #333;">
                <p>${saudacao},</p>
                <p>Segue planejamento para o projeto:</p>
                <p style="font-size: 14px;"><strong>${codProjeto}  ${nomeProjeto}</strong></p>
                <br>
                <table style="width: 100%; max-width: 650px; border-collapse: collapse; font-family: 'Segoe UI', sans-serif;">
                    <thead>
                        <tr style="background-color: #002233; color: white;">
                            <th style="padding: 10px; border: 1px solid #000; text-align:center;">ATIVIDADE</th> 
                            <th style="padding: 10px; border: 1px solid #000; width: 70px; text-align:center;">IN√çCIO</th>
                            <th style="padding: 10px; border: 1px solid #000; width: 70px; text-align:center;">FIM</th>
                            <th style="padding: 10px; border: 1px solid #000; width: 60px; text-align:center;">HORAS</th>
                            <th style="padding: 10px; border: 1px solid #000; width: 110px; text-align:center;">ANALISTA</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${linhasHTML}
                        <tr>
                            <td colspan="3" style="text-align: right; font-weight: bold; padding: 10px; border: 1px solid #ccc; background-color: #fafafa;">TOTAL</td>
                            <td style="text-align: center; font-weight: bold; padding: 10px; border: 1px solid #ccc; background-color: #fafafa;">${totalFmt}</td>
                            <td style="border: 1px solid #ccc; background-color: #fafafa;"></td>
                        </tr>
                    </tbody>
                </table>
                ${blocoObservacao}  <br>
                <p>Fico √† disposi√ß√£o para qualquer d√∫vida.</p>
                <p>Atenciosamente,</p>
            </div>
        `;
        
        document.getElementById('areaTabela').innerHTML = htmlTabela;
        
        // 4. Dispara salvamento (Debounced)
        triggerSalvar();
    }

    // --- UX / TOAST / COPY ---

    function mostrarToast(txt) {
        const x = document.getElementById("toast");
        x.textContent = txt; 
        x.className = "show";
        // Limpa timeout anterior se houver (para n√£o piscar err√°tico se chamar v√°rias vezes)
        if(x.dataset.timeoutId) clearTimeout(x.dataset.timeoutId);
        
        const tId = setTimeout(() => { x.className = x.className.replace("show", ""); }, 3000);
        x.dataset.timeoutId = tId;
    }

    function copiarTexto(id) {
        const el = document.getElementById(id);
        if(el && el.textContent) {
            navigator.clipboard.writeText(el.textContent)
                .then(() => mostrarToast("Assunto copiado!"))
                .catch(() => mostrarToast("Erro ao copiar."));
        }
    }

    function copiarTabela() {
        const el = document.getElementById('resultadoCorpo');
        if(!el) return;
        
        // Sele√ß√£o e c√≥pia precisa para Rich Text (Gmail/Outlook)
        const range = document.createRange();
        range.selectNode(el);
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
        
        try {
            document.execCommand('copy');
            mostrarToast("Tabela copiada (Cole no e-mail)!");
        } catch (err) {
            mostrarToast("Erro ao copiar tabela.");
        }
        
        selection.removeAllRanges();
    }

    function limparTudo() {
        if (confirm("Tem certeza? Isso apagar√° o formul√°rio atual.")) {
            document.getElementById('txtCodProjeto').value='';
            document.getElementById('txtNomeProjeto').value='';
            document.getElementById('txtObservacao').value='';
            document.getElementById('listaItens').innerHTML='';
            
            // Remove do storage o ID atual
            localStorage.removeItem('planejamento_' + currentInstanceId);
            
            // Reseta para um novo ID limpo para evitar conflitos
            const novoId = 'temp_' + Date.now().toString(36);
            const novaUrl = window.location.pathname + '?id=' + novoId;
            window.history.replaceState({path: novaUrl}, '', novaUrl);
            currentInstanceId = novoId;

            iniciarTelaPadrao();
        }
    }

    // --- EVENT LISTENERS GLOBAIS ---

    document.addEventListener('keydown', e => {
        // Atalho Ctrl+Z
        if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'z') {
            const tag = document.activeElement.tagName.toLowerCase();
            // Evita disparar se estiver digitando num input (comportamento padr√£o do browser)
            if(tag !== 'input' && tag !== 'textarea') { 
                e.preventDefault(); 
                desfazerExclusao(); 
            }
        }
    });

    window.onload = function() {
        carregarDadosIniciais();
        
        const el = document.getElementById('listaItens');
        // Inicializa Drag and Drop
        Sortable.create(el, { 
            handle: '.drag-handle', 
            animation: 150, 
            ghostClass: 'sortable-ghost',
            onEnd: gerarTabela // Regenera a tabela ao soltar o item
        });
    };
    </script>
</body>
</html>