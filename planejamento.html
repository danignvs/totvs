<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Planejamento</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="style.css">

    <style>

        .container {
            grid-template-columns: 1fr 1.5fr;
        }

        .wrapper {
            padding: 7px;
            background-color: var(--cinza-claro);
            border-radius: 3px;
            border: 1px solid var(--cinza);
            position: relative;
            transition: background-color 0.2s;
        }

        .item-lista {
            margin: 10px 0;
        }

        .inp-tarefa {
            width: 100%;
        }

        .marco, .inp-tarefa {
            display: flex;
            align-items: center;
            gap: 7px;
        }
        
        .marco .drag-handle, .marco .excluir {
            color: var(--roxo);
            font-weight: bold;
        }

        .tarefa .drag-handle, .tarefa .excluir {
            color: var(--laranja);
            font-weight: bold;
        }

        .excluir {
            font-size: 1em;
            font-weight: bold;
            width: auto;
            padding: 0 5px 0 0px;
            float: right;
        }

        .sortable-ghost {
            opacity: 0.4;
            background-color: var(--cinza-claro);
            border: 2px dashed var(--az-claro);
        }

        /* --- CORRE√á√ÉO DA TABELA --- */
        .container-resultado {
            max-width: 100%;
        }

        .tabela-container {
            width: 100%;
            overflow-x: auto; /* Cria barra de rolagem se a tabela for grande */
            background: #fff;
            padding: 10px;
            border: 1px solid var(--cinza);
            border-radius: 3px;
            box-sizing: border-box; /* Garante que padding n√£o aumente a largura total */
        }

        pre, .tabela-container {
            font-family: Verdana, Geneva, Tahoma, sans-serif;
            font-size: 0.8rem;
        }

        table.custom-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            color: #333;
        }

        table.custom-table th {
            background-color: var(--az-escuro);
            color: white;
            font-weight: bold;
            padding: 10px;
            border: 1px solid var(--az-claro);
            text-align: center;
            vertical-align: middle;
        }

        table.custom-table td {
            padding: 8px;
            border: 1px solid #ccc;
            text-align: center;
            vertical-align: middle;
        }

        table.custom-table td.col-tarefa {
            text-align: left;
            font-weight: 500;
        }

        table.custom-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
            
        /* Inputs de data (In√≠cio e Fim) na mesma linha */
        .tarefa .input-group:nth-child(2) { 
            display: flex;
        }
        
        /* Inputs de Horas e Analista na mesma linha */
        .tarefa .input-group:nth-child(3) { 
            display: flex;
        }

        /* Define larguras espec√≠ficas para ficar proporcional */
        .tarefa .input-group:nth-child(3) .input-item:first-child {
            flex: 1; /* Horas ocupa menos espa√ßo (1 parte) */
        }
        
        .tarefa .input-group:nth-child(3) .input-item:last-child {
            flex: 3; /* Analista ocupa mais espa√ßo (2 partes) */
        }


    </style>
</head>

<body>

    <h1>Planejamento de Projetos</h1>

    <div class="container container-azul">

        <datalist id="lista-analistas">
            <option value="Anderson Guilherme">
            <option value="Andre Ferreira">
            <option value="Bruno Silva">
            <option value="Cassio Moraes">
            <option value="Daly Teixeira">
            <option value="Douglas Eduardo">
            <option value="Douglas Rafael">
            <option value="Eduardo Cruz">
            <option value="Felipe Oliveira">
            <option value="Filippe Valle">
            <option value="Gustavo Mizerani">
            <option value="Jairo Da Silva">
            <option value="Karlo Guilherme">
            <option value="Kleverson Nascimento">
            <option value="Leonardo Ventura">
            <option value="Magno Telles">
            <option value="Marcelo Veiga">
            <option value="Marcio Avila">
            <option value="Mario Flavio">
            <option value="Moacyr Campos">
            <option value="Pablo Barbero">
            <option value="Paulo Roberto">
            <option value="Pedro Henrique">
            <option value="Ricardo Mendes">
            <option value="Talles Da Silva">
            <option value="Washington Da Silva">
            <option value="Yure Jonathan">
        </datalist>


        <section class="container-formulario">

            <div class="topo">
                <h2></h2>
            </div>

            <div class="input-group">
                <div class="input-item">
                    <label for="txtCodProjeto">C√≥digo do Projeto:</label>
                    <input type="text" id="txtCodProjeto" placeholder="Ex: D...001" oninput="gerarTabela()">
                </div>
                <div class="input-item">
                    <label for="txtNomeProjeto">Nome do Projeto:</label>
                    <input type="text" id="txtNomeProjeto" placeholder="Nome do projeto" oninput="gerarTabela()">
                </div>
            </div>

            <label style="margin-bottom: -7px;">Marcos e Tarefas:</label>
            <div id="listaItens">
            </div>

            <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="processarArquivo(this)">

            <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                <button class="btn-roxo" style="flex: 1;" onclick="adicionarMarcoItem()">Adicionar Marco</button>
                <button class="btn-laranja" style="flex: 1;" onclick="adicionarNovaTarefa()">Adicionar Tarefa</button>
            </div>

        </section>


        <section class="container-resultado">
            <div class="topo">
                <h3></h3>
            </div>

            <div class="resultado">
                <button class="btn-azul btn-aux" onclick="copiarTexto('resultadoAssunto')">Copiar</button>
                <label>Assunto:</label>
                <pre id="resultadoAssunto"></pre>
            </div>

            <div class="resultado">
                <button class="btn-azul btn-aux" onclick="copiarTabela()">Copiar</button>
                <label>Mensagem:</label>
                <div id="areaTabela" class="tabela-container"></div>
            </div>
        </section>


        <div id="toast">Copiado!</div>
    </div>
                
    
    <div class="menu">
        <button onclick="document.getElementById('fileInput').click()">Carregar Arquivo</button>
        
        <button onclick="baixarBackup()">Salvar</button> 
        
        <button onclick="limparTudo()">Limpar</button>

    </div>

    <script>
        // --- GERENCIAMENTO DE INST√ÇNCIA E URL ---
        // Pega o ID da URL ou gera um aleat√≥rio se estiver vazio
        function obterIdInstancia() {
            const params = new URLSearchParams(window.location.search);
            let id = params.get('id');
            if (!id) {
                id = Date.now().toString(36);
                atualizarUrl(id);
            }
            return id;
        }

        function atualizarUrl(novoId) {
            // Remove espa√ßos e caracteres especiais para a URL ficar limpa
            const idLimpo = novoId.trim().replace(/[^a-zA-Z0-9-_]/g, '');
            if (!idLimpo) return;

            const novaUrl = window.location.pathname + '?id=' + encodeURIComponent(idLimpo);
            window.history.replaceState({path: novaUrl}, '', novaUrl);
            
            // Atualiza a vari√°vel global de controle
            currentInstanceId = idLimpo;
        }

        let currentInstanceId = obterIdInstancia();

        // --- FOR√áAR TOPO ---
        if (history.scrollRestoration) history.scrollRestoration = 'manual';
        window.scrollTo(0, 0);
        
        // --- SAUDA√á√ÉO ---
        function obterSaudacao() {
            const hora = parseInt(new Date().toLocaleString("pt-BR", { timeZone: "America/Sao_Paulo", hour: "numeric", hour12: false }));
            if (hora >= 0 && hora < 12) return "Bom dia";
            if (hora >= 12 && hora < 18) return "Boa tarde";
            return "Boa noite";
        }

        // --- M√ÅSCARAS E VALIDA√á√ïES ---
        function mascaraData(input) {
            let v = input.value.replace(/\D/g, "");
            if (v.length > 2) v = v.substring(0, 2) + "/" + v.substring(2);
            if (v.length > 5) v = v.substring(0, 5) + "/" + v.substring(5, 9);
            if (v.length > 10) v = v.substring(0, 10);
            input.value = v;
            validarDatas(input);
            gerarTabela();
        }

        function validarDatas(input) {
            const wrapper = input.closest('.wrapper');
            if (!wrapper) return;
            const inpInicio = wrapper.querySelector('.inp-inicio');
            if (!inpInicio) return; 
            const inpFim = wrapper.querySelector('.inp-fim');
            
            if (inpInicio.value.length === 10 && inpFim.value.length === 10) {
                const i = inpInicio.value.split('/');
                const f = inpFim.value.split('/');
                const dInicio = new Date(i[2], i[1]-1, i[0]);
                const dFim = new Date(f[2], f[1]-1, f[0]);
                if (dFim < dInicio) {
                    mostrarToast("Data final menor que inicial!");
                    inpFim.value = "";
                    wrapper.querySelectorAll('.inp-date-picker')[1].value = "";
                }
            }
        }

        function atualizarDataPeloPicker(pickerInput) {
            const valorISO = pickerInput.value;
            if (!valorISO) return;
            const [ano, mes, dia] = valorISO.split('-');
            const wrapper = pickerInput.parentElement;
            const textInput = wrapper.querySelector('.inp-date-text');
            if (textInput) {
                textInput.value = `${dia}/${mes}/${ano}`;
                validarDatas(textInput);
                gerarTabela();
            }
        }

        function formatarDataFinal(valor) {
            if (!valor) return "";
            if (valor.length === 10 && valor.includes('/')) return valor.substring(0, 6) + valor.substring(8, 10);
            return valor;
        }

        // --- MANIPULA√á√ÉO DO DOM (ITENS) ---
        let historicoExclusoes = [];

        function adicionarNovaTarefa() {
            criarElemento('tarefa');
        }

        function adicionarMarcoItem() {
            criarElemento('marco');
        }

        function criarElemento(tipo, dados = null) {
            const container = document.getElementById('listaItens');
            const idUnico = Date.now() + Math.random().toString(16).slice(2);
            const div = document.createElement('div');
            
            div.id = 'item-' + idUnico;
            div.dataset.type = tipo;
            
            if (tipo === 'tarefa') {
                div.className = 'wrapper item-lista tarefa';
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center; gap: 7px; ">
                        <div style="display:flex; align-items:center; flex:1; gap: 7px;">
                            <span class="drag-handle" title="Mover">‚ò∞</span>
                            <input type="text" class="inp-tarefa" placeholder="Descri√ß√£o da tarefa..." oninput="gerarTabela()" style="margin:0; width:100%; margin: 5px 0;">
                        </div>
                        <button class="excluir" style="margin:0;" onclick="removerItem('${idUnico}')">X</button>
                    </div>
                    <div class="input-group">
                        <div class="input-item">
                            <div class="custom-date-wrapper">
                                <input type="text" class="inp-date-text inp-inicio" placeholder="Data In√≠cio" maxlength="10" oninput="mascaraData(this)">
                                <span class="calendar-icon">üìÖ</span>
                                <input type="date" class="inp-date-picker" onchange="atualizarDataPeloPicker(this)">
                            </div>
                        </div>
                        <div class="input-item">
                            <div class="custom-date-wrapper">
                                <input type="text" class="inp-date-text inp-fim" placeholder="Data Conclus√£o" maxlength="10" oninput="mascaraData(this)">
                                <span class="calendar-icon">üìÖ</span>
                                <input type="date" class="inp-date-picker" onchange="atualizarDataPeloPicker(this)">
                            </div>
                        </div>
                    </div>
                    <div class="input-group" style="margin-bottom:0;">
                        <div class="input-item">
                            <input type="text" class="inp-horas" placeholder="Horas (0,00)" oninput="gerarTabela()">
                        </div>
                        <div class="input-item">
                            <input type="text" class="inp-analista" list="lista-analistas" placeholder="Nome do Analista" oninput="gerarTabela()">
                        </div>
                    </div>
                `;
            } else {
                div.className = 'wrapper item-lista marco';
                div.innerHTML = `
                    <span class="drag-handle" title="Mover">‚ò∞</span>
                    <input type="text" class="inp-marco" placeholder="Marco" oninput="gerarTabela()" style="flex:1;">
                    <button class="excluir" style="margin:0;" onclick="removerItem('${idUnico}')">X</button>
                `;
            }

            container.appendChild(div);

            // Se vieram dados (importa√ß√£o ou carregar), preenche os campos
            if (dados) {
                if (tipo === 'tarefa') {
                    div.querySelector('.inp-tarefa').value = dados.tarefa || '';
                    div.querySelector('.inp-inicio').value = dados.inicio || '';
                    div.querySelector('.inp-fim').value = dados.fim || '';
                    div.querySelector('.inp-horas').value = dados.horas || '';
                    div.querySelector('.inp-analista').value = dados.analista || '';
                } else {
                    div.querySelector('.inp-marco').value = dados.valor || '';
                }
            }

            gerarTabela();
        }

        function removerItem(id) {
            const el = document.getElementById('item-' + id);
            if (el) {
                const tipo = el.dataset.type;
                let valores = {};
                if (tipo === 'tarefa') {
                    valores = {
                        tarefa: el.querySelector('.inp-tarefa').value,
                        inicio: el.querySelector('.inp-inicio').value,
                        fim: el.querySelector('.inp-fim').value,
                        horas: el.querySelector('.inp-horas').value,
                        analista: el.querySelector('.inp-analista').value
                    };
                } else {
                    valores = { valor: el.querySelector('.inp-marco').value };
                }
                // Adiciona ao hist√≥rico com o nome correto das propriedades para o restaurar funcionar
                historicoExclusoes.push({ id, tipo, valores }); 
                el.remove();
                gerarTabela();
                mostrarToast("Item removido. Ctrl+Z para desfazer.");
            }
        }

        function desfazerExclusao() {
            if (historicoExclusoes.length === 0) return;
            const item = historicoExclusoes.pop();
            // Reutiliza a fun√ß√£o de criar elemento passando os dados salvos
            criarElemento(item.tipo, item.valores);
            mostrarToast("Desfeito!");
        }

        // --- SISTEMA DE ARQUIVOS E SALVAMENTO ---

        function coletarDadosParaSalvar() {
            const dados = {
                codProjeto: document.getElementById('txtCodProjeto').value,
                nomeProjeto: document.getElementById('txtNomeProjeto').value,
                itens: []
            };

            document.querySelectorAll('.item-lista').forEach(el => {
                if (el.dataset.type === 'marco') {
                    dados.itens.push({
                        type: 'marco',
                        valor: el.querySelector('.inp-marco').value
                    });
                } else {
                    dados.itens.push({
                        type: 'tarefa',
                        tarefa: el.querySelector('.inp-tarefa').value,
                        inicio: el.querySelector('.inp-inicio').value,
                        fim: el.querySelector('.inp-fim').value,
                        horas: el.querySelector('.inp-horas').value,
                        analista: el.querySelector('.inp-analista').value
                    });
                }
            });
            return dados;
        }

        function salvarDadosAuto() {
            const dados = coletarDadosParaSalvar();
            
            // L√≥gica de URL: Se o c√≥digo do projeto mudar, atualiza a URL
            if (dados.codProjeto && dados.codProjeto !== currentInstanceId) {
                atualizarUrl(dados.codProjeto);
            }

            // Salva no LocalStorage usando o ID atual da URL
            localStorage.setItem('planejamento_' + currentInstanceId, JSON.stringify(dados));
        }

        function baixarBackup() {
            const dados = coletarDadosParaSalvar();
            const nomeArquivo = `Planejamento_${dados.codProjeto || 'Novo'}.json`;
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(dados));
            
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", nomeArquivo);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function processarArquivo(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const dados = JSON.parse(e.target.result);
                    restaurarTela(dados);
                    mostrarToast("Arquivo carregado com sucesso!");
                } catch (err) {
                    alert("Erro ao ler o arquivo JSON.");
                }
                input.value = ''; // Limpa o input para permitir carregar o mesmo arquivo novamente
            };
            reader.readAsText(file);
        }

        function carregarDadosIniciais() {
            // Tenta carregar do LocalStorage usando o ID da URL
            const dadosSalvos = localStorage.getItem('planejamento_' + currentInstanceId);
            if (dadosSalvos) {
                restaurarTela(JSON.parse(dadosSalvos));
            } else {
                // Se n√£o tem nada salvo, inicia padr√£o
                adicionarMarcoItem();
                adicionarNovaTarefa();
                gerarTabela();
            }
        }

        function restaurarTela(dados) {
            document.getElementById('txtCodProjeto').value = dados.codProjeto || '';
            document.getElementById('txtNomeProjeto').value = dados.nomeProjeto || '';
            
            // Atualiza URL se for um arquivo carregado
            if(dados.codProjeto) atualizarUrl(dados.codProjeto);

            const container = document.getElementById('listaItens');
            container.innerHTML = '';

            if (dados.itens && dados.itens.length > 0) {
                dados.itens.forEach(item => {
                    criarElemento(item.type, item); // item j√° tem a estrutura de dados correta
                });
            } else {
                adicionarMarcoItem();
                adicionarNovaTarefa();
            }
            gerarTabela();
        }

        // --- GERA√á√ÉO DA TABELA ---
        function gerarTabela() {
            const codProjeto = document.getElementById('txtCodProjeto').value;
            const nomeProjeto = document.getElementById('txtNomeProjeto').value;

            let assunto = "Libera√ß√£o para Planejamento";
            if (codProjeto) assunto += ` - ${codProjeto}`;
            if (nomeProjeto) assunto += ` - ${nomeProjeto}`;
            document.getElementById('resultadoAssunto').textContent = assunto;

            const itens = document.querySelectorAll('.item-lista');
            let linhasHTML = '';
            let totalHoras = 0;

            itens.forEach(el => {
                if (el.dataset.type === 'marco') {
                    const titulo = el.querySelector('.inp-marco').value.toUpperCase();
                    linhasHTML += `
                        <tr>
                            <td colspan="5" style="background-color: #f0f0f0; font-weight: bold; text-align: left; padding: 10px; border: 1px solid #ccc; color: #002233;">${titulo}</td>
                        </tr>
                    `;
                } else {
                    let desc = el.querySelector('.inp-tarefa').value;
                    if (desc.length > 0) desc = desc.charAt(0).toUpperCase() + desc.slice(1);
                    
                    const inicio = el.querySelector('.inp-inicio').value;
                    const fim = el.querySelector('.inp-fim').value;
                    let horasStr = el.querySelector('.inp-horas').value.replace(',', '.');
                    const analista = el.querySelector('.inp-analista').value;

                    const h = parseFloat(horasStr);
                    if (!isNaN(h)) totalHoras += h;

                    const iniFmt = formatarDataFinal(inicio);
                    const fimFmt = formatarDataFinal(fim);
                    const horasExib = horasStr.replace('.', ',');

                    if (desc || inicio || fim || horasStr || analista) {
                        linhasHTML += `
                            <tr>
                                <td style="text-align: left; padding: 8px; border: 1px solid #ccc;">${desc}</td>
                                <td style="text-align: center; padding: 8px; border: 1px solid #ccc;">${iniFmt}</td>
                                <td style="text-align: center; padding: 8px; border: 1px solid #ccc;">${fimFmt}</td>
                                <td style="text-align: center; padding: 8px; border: 1px solid #ccc;">${horasExib}</td>
                                <td style="text-align: center; padding: 8px; border: 1px solid #ccc;">${analista}</td>
                            </tr>
                        `;
                    }
                }
            });

            const totalFmt = totalHoras.toFixed(2).replace('.', ',');
            const saudacao = obterSaudacao();

            const htmlTabela = `
                <div id="resultadoCorpo" style="font-family: Verdana, Geneva, Tahoma, sans-serif; font-size: 13px; color: #333;">
                    <p>${saudacao},</p>
                    <p>Segue planejamento para o projeto:</p>
                    <strong>${codProjeto}  ${nomeProjeto}</strong>
                    <br><br>
                    <table style="width: 100%; max-width: 600px; border-collapse: collapse; font-family: 'Segoe UI', sans-serif;">
                        <thead>
                            <tr style="background-color: #002233; color: white;">
                                <th style="padding: 10px; border: 1px solid #000;"></th> 
                                <th style="padding: 10px; border: 1px solid #000; width: 80px;">IN√çCIO</th>
                                <th style="padding: 10px; border: 1px solid #000; width: 80px;">CONCLUS√ÉO</th>
                                <th style="padding: 10px; border: 1px solid #000; width: 60px;">HORAS</th>
                                <th style="padding: 10px; border: 1px solid #000; width: 100px;">ANALISTA</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${linhasHTML}
                            <tr>
                                <td colspan="3" style="text-align: right; font-weight: bold; padding: 10px; border: 1px solid #ccc;">TOTAL</td>
                                <td style="text-align: center; font-weight: bold; padding: 10px; border: 1px solid #ccc;">${totalFmt}</td>
                                <td style="border: 1px solid #ccc;"></td>
                            </tr>
                        </tbody>
                    </table>
                    <br>
                    <p>Fico √† disposi√ß√£o para qualquer d√∫vida.</p>
                    <p>Atenciosamente,</p>
                </div>
            `;
            document.getElementById('areaTabela').innerHTML = htmlTabela;
            
            salvarDadosAuto(); // CHAMA O SALVAMENTO A CADA GERAR TABELA
        }

        // Utils
        function mostrarToast(txt) {
            const x = document.getElementById("toast");
            x.textContent = txt; x.className = "show";
            setTimeout(() => { x.className = x.className.replace("show", ""); }, 3000);
        }
        function copiarTexto(id) {
            const txt = document.getElementById(id).textContent;
            if(txt) navigator.clipboard.writeText(txt).then(() => mostrarToast("Copiado!"));
        }
        function copiarTabela() {
            const el = document.getElementById('resultadoCorpo');
            if(!el) return;
            const r = document.createRange(); r.selectNode(el);
            window.getSelection().removeAllRanges(); window.getSelection().addRange(r);
            document.execCommand('copy');
            window.getSelection().removeAllRanges();
            mostrarToast("Tabela copiada!");
        }
        function limparTudo() {
            if (confirm("Deseja limpar tudo?")) {
                document.getElementById('txtCodProjeto').value='';
                document.getElementById('txtNomeProjeto').value='';
                document.getElementById('listaItens').innerHTML='';
                localStorage.removeItem('planejamento_' + currentInstanceId); // Limpa storage atual
                
                // Reseta ID para um novo aleat√≥rio para evitar conflito se recarregar
                atualizarUrl(Date.now().toString(36));
                
                adicionarMarcoItem();
                adicionarNovaTarefa(); 
                gerarTabela();
            }
        }

        document.addEventListener('keydown', e => {
            if((e.ctrlKey || e.metaKey) && e.key === 'z') {
                const tag = document.activeElement.tagName.toLowerCase();
                if(tag !== 'input' && tag !== 'textarea') { e.preventDefault(); desfazerExclusao(); }
            }
        });

        window.onload = function() {
            carregarDadosIniciais();
            const el = document.getElementById('listaItens');
            Sortable.create(el, { handle: '.drag-handle', animation: 150, onEnd: gerarTabela });
        };
    </script>
</body>
</html>